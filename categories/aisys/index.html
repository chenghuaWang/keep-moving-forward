<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>AI&amp;Sys | Ubios Home</title>
<meta name="keywords" content="">
<meta name="description" content="Ubios&#39; Blog. AI &amp; Sys">
<meta name="author" content="chenghua.wang">
<link rel="canonical" href="https://chenghuawang.github.io/keep-moving-forward/categories/aisys/">
<link crossorigin="anonymous" href="/keep-moving-forward/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://chenghuawang.github.io/keep-moving-forward/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://chenghuawang.github.io/keep-moving-forward/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://chenghuawang.github.io/keep-moving-forward/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://chenghuawang.github.io/keep-moving-forward/apple-touch-icon.png">
<link rel="mask-icon" href="https://chenghuawang.github.io/keep-moving-forward/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" type="application/rss+xml" href="https://chenghuawang.github.io/keep-moving-forward/categories/aisys/index.xml">
<link rel="alternate" hreflang="en" href="https://chenghuawang.github.io/keep-moving-forward/categories/aisys/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

  

<meta property="og:title" content="AI&amp;Sys" />
<meta property="og:description" content="Ubios&#39; Blog. AI &amp; Sys" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://chenghuawang.github.io/keep-moving-forward/categories/aisys/" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="AI&amp;Sys"/>
<meta name="twitter:description" content="Ubios&#39; Blog. AI &amp; Sys"/>

</head>

<body class="list" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://chenghuawang.github.io/keep-moving-forward/" accesskey="h" title="Ubios Home (Alt + H)">Ubios Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://chenghuawang.github.io/keep-moving-forward/about/about/" title="å…³äºæˆ‘">
                    <span>å…³äºæˆ‘</span>
                </a>
            </li>
            <li>
                <a href="https://chenghuawang.github.io/keep-moving-forward/about/tech_posts/" title="æŠ€æœ¯ç›¸å…³">
                    <span>æŠ€æœ¯ç›¸å…³</span>
                </a>
            </li>
            <li>
                <a href="https://chenghuawang.github.io/keep-moving-forward/about/paper_posts/" title="è®ºæ–‡è§£æ">
                    <span>è®ºæ–‡è§£æ</span>
                </a>
            </li>
            <li>
                <a href="https://chenghuawang.github.io/keep-moving-forward/about/news/" title="ğŸ‰NewsğŸ‰">
                    <span>ğŸ‰NewsğŸ‰</span>
                </a>
            </li>
            <li>
                <a href="https://chenghuawang.github.io/keep-moving-forward/about/thingking/" title="æ€è€ƒ">
                    <span>æ€è€ƒ</span>
                </a>
            </li>
            <li>
                <a href="https://chenghuawang.github.io/keep-moving-forward/about/hpc_ai/" title="AI&amp;Sys å…¥é—¨">
                    <span>AI&amp;Sys å…¥é—¨</span>
                </a>
            </li>
            <li>
                <a href="https://chenghuawang.github.io/keep-moving-forward/tags/" title="æ ‡ç­¾">
                    <span>æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://chenghuawang.github.io/keep-moving-forward/series" title="ç³»åˆ—æ–‡ç« ">
                    <span>ç³»åˆ—æ–‡ç« </span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main"> 
<header class="page-header"><div class="breadcrumbs"><a href="https://chenghuawang.github.io/keep-moving-forward/">Home</a>&nbsp;Â»&nbsp;<a href="https://chenghuawang.github.io/keep-moving-forward/categories/">Categories</a></div>
  <h1>
    AI&amp;Sys
    <a href="/keep-moving-forward/categories/aisys/index.xml" title="RSS" aria-label="RSS">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round" height="23">
        <path d="M4 11a9 9 0 0 1 9 9" />
        <path d="M4 4a16 16 0 0 1 16 16" />
        <circle cx="5" cy="19" r="1" />
      </svg>
    </a>
  </h1>
</header>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2 class="entry-hint-parent">Roofline Model
    </h2>
  </header>
  <div class="entry-content">
    <p>åœ¨ç¼–å†™ç®—å­å’Œæ¡†æ¶çš„æ—¶å€™ï¼Œç»å¸¸éœ€è¦åˆ†æç¨‹åºçš„æ€§èƒ½ç“¶é¢ˆã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªåˆé€‚çš„æŒ‡æ ‡å’ŒæŒ‡å¯¼æ–¹æ³•ï¼ŒRoofline modelç»™å‡ºäº†ä¸€ä¸ªç®€æ´çš„å®šé‡åˆ†ææ–¹æ³•ã€‚Rooflineæ¨¡å‹å¼•å…¥äº†ä¸€ç§åŸºäºOperational Intensityçš„å®šé‡åˆ†ææ–¹æ³•ï¼Œå®ƒå®šä¹‰äº†åœ¨è®¡ç®—å¹³å°ä¸Šå¯å®ç°çš„ç†è®ºæœ€å¤§è®¡ç®—æ•ˆç‡ã€‚è¯¥æ¨¡å‹è¿˜æä¾›äº†ä¸€ä¸ªå…¬å¼ï¼Œç”¨ä»¥è®¡ç®—åœ¨ç‰¹å®šè®¡ç®—ç¯å¢ƒä¸­å¯èƒ½è¾¾åˆ°çš„æœ€é«˜ç†è®ºæ€§èƒ½ã€‚
æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹roofline modelçš„ç›´è§‚è¡¨ç¤ºï¼š
Roofline ModelRoofline: An Insightful Visual Performance Model for Floating-Point Programs and Multicore Architectures
æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹å›¾ä¸­æŒ‡æ ‡çš„å®šä¹‰ï¼š
è®¡ç®—å¼ºåº¦ $I$ : æ¯Byteå†…å­˜åœ¨äº¤æ¢åç”¨äºè¿›è¡Œäº†å¤šå°‘æµ®ç‚¹è¿ç®—ï¼Œå³FLOPs/Bytesã€‚æ¨¡å‹çš„è®¡ç®—å¼ºåº¦$I$è¶Šå¤§ï¼Œå¯¹äºå†…å­˜å¸¦å®½çš„å‹åŠ›è¶Šå°ï¼Œå†…å­˜çš„ä½¿ç”¨æ•ˆç‡è¶Šé«˜ã€‚
ç®—åŠ›çš„å¤§å°å†³å®šäº†å±‹é¡¶çš„é«˜åº¦ï¼Œå¸¦å®½å†³å®šäº†æ–œç‡ã€‚
åœ¨è¾¾åˆ°å±‹é¡¶çš„è½¬æŠ˜ç‚¹ä¹‹å‰éƒ½æ˜¯Memory Boundï¼Œåœ¨ä¹‹åæ˜¯Compute Boundã€‚åœ¨Compute Boundçš„åŒºåŸŸï¼Œä¸ç®¡è®¡ç®—å¼ºåº¦$I$æœ‰å¤šå¤§ï¼Œå®ƒçš„è®¡ç®—æ€§èƒ½éƒ½ç”±æœºå™¨çš„å®é™…æœ€å¤§è®¡ç®—æ€§èƒ½æ‰€é™åˆ¶ã€‚
Note:
roofline modelè®²çš„æ˜¯ç¨‹åºç†è®ºä¸Šå¯ä»¥è¾¾åˆ°çš„æœ€å¥½æ€§èƒ½ï¼Œè€Œä¸æ˜¯å®é™…è¾¾åˆ°çš„æ€§èƒ½ã€‚å¦‚cacheå¤§å°çš„é™åˆ¶ï¼Œç½‘ç»œé™åˆ¶ï¼Œæœªå¿…èƒ½è¾¾åˆ°rooflineæ¨¡å‹å®šä¹‰çš„è¾¹ç•Œã€‚ </p>
  </div>
  <footer class="entry-footer"><span title='2024-10-12 00:00:00 +0000 UTC'>October 12, 2024</span>&nbsp;Â·&nbsp;1 min&nbsp;Â·&nbsp;chenghua.Wang</footer>
  <a class="entry-link" aria-label="post link to Roofline Model" href="https://chenghuawang.github.io/keep-moving-forward/tech/roofline_model/"></a>
</article>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2 class="entry-hint-parent">Xnnpack ä½¿ç”¨æŒ‡å—
    </h2>
  </header>
  <div class="entry-content">
    <p>0x01 å‰è¨€ XNNPACKæ˜¯ä¸€ä¸ªç”±Googleç»´æŠ¤çš„ç®—å­åº“ï¼Œåœ¨TensorFlowLiteï¼ŒExecuTorchï¼ŒONNX RTç­‰ä¼—å¤šçŸ¥åæ¡†æ¶ä¸­ä½¿ç”¨ã€‚ç¬”è€…æœ€è¿‘åœ¨åšmllmçš„xnnpackåç«¯é€‚é…å·¥ä½œï¼Œå› xnnpackç¼ºå°‘æ–‡æ¡£ï¼Œåœ¨æ­¤è®°å½•ã€‚
xnnpackçš„testä¸­å±•ç¤ºäº†å¤§éƒ¨åˆ†xnnpackçš„APIå’Œä½¿ç”¨æ–¹å¼ï¼Œè¯»è€…åœ¨ç¢°åˆ°APIä½¿ç”¨é—®é¢˜çš„æ—¶å€™ä¸å¦¨å»testæ–‡ä»¶å¤¹ä¸‹é¢æ‰¾æ‰¾ç­”æ¡ˆï¼›xnnpackéµå¾ªæ ‡å‡†çš„doxygenæ³¨é‡Šï¼Œä¹Ÿè¾ƒå¥½çš„è¯´æ˜äº†å‡½æ•°å’Œclassçš„ä½¿ç”¨æ–¹æ³•ã€‚
åœ¨xnnä¸­ä½¿ç”¨çš„æ˜¯é™æ€å›¾æ„å»ºçš„æ–¹æ³•ï¼Œåœ¨å¼€å§‹æ„å»ºé™æ€å›¾ä¹‹å‰ï¼Œéœ€è¦åˆå§‹åŒ–xnnï¼š
xnn_initialize(nullptr /* allocator */) ä½¿ç”¨å¦‚ä¸‹APIå¯ä»¥æ„å»ºå‡ºä¸€å¼ subgraphï¼Œæ¥ä¸‹æ¥çš„æ‰€æœ‰æ“ä½œéƒ½åœ¨æ›´æ”¹è¿™å¼ å­å›¾ï¼Œ
xnn_subgraph_t subgraph_ = nullptr; auto status = xnn_create_subgraph(external_nums, 0, &amp;subgraph_); 0x02 å®šä¹‰ Tensor å®šä¹‰æœªç»è¿‡é‡åŒ–çš„Tensorä½¿ç”¨çš„APIæ˜¯ï¼š
uint32_t uuid; status = xnn_define_tensor_value( /*subgraph*/..., /*dtype*/..., dims.size(), dims.data(), /*data=*/..., /*external id*/XNN_INVALID_VALUE_ID, /*flag*/0, /*id*/&amp;uuid); è¿™é‡Œéœ€è¦ç‰¹æ®Šè§£é‡Šçš„æ˜¯external_idã€flagå’Œuuidä¸‰ä¸ªå€¼ï¼š
external_id æ˜¯å¯¹äºEXternal Inputså’ŒOutputsæ‰éœ€è¦è®¾ç½®çš„ï¼Œå¯¹äºxnnpackå†…éƒ¨ç®¡ç†çš„Tensorï¼Œä¸éœ€è¦è®¾ç½®è¿™ä¸ªå€¼ï¼Œç»™å‡ºé»˜è®¤çš„XNN_INVALID_VALUE_IDå°±è¡Œã€‚external_idçš„ä½œç”¨æ˜¯è®©xnnpackå¯ä»¥ä»runtimeä¸­ä¼ å…¥çš„external_valuesä¸­ç´¢å¼•åˆ°éœ€è¦çš„Tensorå€¼ã€‚è¯¦ç»†è§£é‡Šå¦‚ä¸‹ï¼š åœ¨xnnpackä¸­ï¼Œæ¯ä¸ªTensoréƒ½ä¼šæœ‰ä¸€ä¸ªuuidï¼Œå¯¹äºxnnpackè‡ªå·±ç®¡ç†çš„Tensorï¼Œuuidåœ¨å®šä¹‰çš„æ—¶å€™ä¼šç”±xnnpackè‡ªå·±ç”Ÿæˆã€‚è¿˜è®°å¾—åœ¨xnn_create_subgraphåˆ›å»ºçš„æ—¶å€™éœ€è¦ä¼ å…¥external_numså—ï¼Ÿè¿™é‡Œçš„external_numså°±æ˜¯ç”¨æˆ·ä¾§é¢„ç•™çš„uuidã€‚æ¯”å¦‚external_numsæ˜¯3çš„æ—¶å€™ï¼Œxnn_define_tensor_valueå°±ä¼šä»4å¼€å§‹è®¡æ•°ç»™æ–°åˆ›å»ºçš„Tensorã€‚è€Œå‰3ä¸ªTensorï¼Œå³external Tensorçš„uuid(external_id)å°±æ˜¯1ï¼Œ2ï¼Œ3ã€‚
flag flagæ˜¯ç”¨æ¥æ ‡è¯†è¿™ä¸ªTensoræ˜¯ä¸æ˜¯External Inputsï¼ŒOutputsæˆ–è€…æ˜¯å…¶ä»–ç±»å‹çš„Tensorã€‚æ¯”å¦‚inputs tensorçš„flagæ˜¯flags = XNN_VALUE_FLAG_EXTERNAL_INPUT;, outputs æ˜¯ flags = XNN_VALUE_FLAG_EXTERNAL_OUTPUT;
uuid æ˜¯æ¯ä¸ªTensorçš„å…¨å±€ç´¢å¼•æ ‡è¯†
é¢˜å¤–è¯ï¼š
åœ¨mllmä¸­ï¼ŒTensorçš„defineè¿‡ç¨‹å¦‚ä¸‹ï¼š
void defineXpTensor(XnnpackBackend *xpb, Tensor *t, XpTensorType ttype) { if (t-&gt;uuid() !...</p>
  </div>
  <footer class="entry-footer"><span title='2024-10-07 00:00:00 +0000 UTC'>October 7, 2024</span>&nbsp;Â·&nbsp;2 min&nbsp;Â·&nbsp;chenghua.Wang</footer>
  <a class="entry-link" aria-label="post link to Xnnpack ä½¿ç”¨æŒ‡å—" href="https://chenghuawang.github.io/keep-moving-forward/tech/xnnpack_guide/"></a>
</article>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2 class="entry-hint-parent">ã€æ–½å·¥ä¸­ã€‘ç«¯ä¾§å¤§æ¨¡å‹æ¨ç†-ç®—æ³•-Part1: Deja Vu, LLM in a Flash
    </h2>
  </header>
  <div class="entry-content">
    <p>æœ¬æ–‡ä¸»è¦æ€»ç»“ä¸¤ç¯‡æ–‡ç« ï¼šDeja Vu å’Œ Apple çš„ LLM in a flashã€‚è¿™ä¸¤ç¯‡æ–‡ç« çš„å†…å®¹éƒ½æ˜¯ç«¯ä¾§æ¨ç†åŠ é€Ÿçš„å°è¯•ï¼Œä»–ä»¬ä¸»è¦ä½¿ç”¨äº†å¤§è‡´çš„æ€è·¯â€“åˆ©ç”¨MLPçš„ç¨€ç–æ€§ï¼Œå„è‡ªçš„å·¥ç¨‹å®ç°å„æœ‰ä¸€äº›åˆ›æ–°ã€‚
Deja Vu: Contextual Sparsity for Efficient LLMs at Inference Time LLM in a flash: Efficient Large Language Model Inference with Limited Memory ç«¯ä¾§æ¨ç†æœ‰ç€æ¯”è¾ƒå¤§çš„åº”ç”¨å‰æ™¯ï¼Œéšç€ç«¯ä¾§è®¾å¤‡çš„ç®—åŠ›è·Ÿè¿›ï¼Œç«¯ä¾§è®¾å¤‡å·²ç»å…·æœ‰äº†è¿è¡Œ7Bæ¨¡å‹çš„èƒ½åŠ›ã€‚åœ¨ç«¯ä¾§è¿è¡Œå°å‚æ•°æ¨¡å‹å¯ä»¥æå¤§çš„å‡å°‘äº‘ç«¯çš„å‹åŠ›ï¼Œä»è€Œå‡å°‘è¿è¥æˆæœ¬ã€‚ç›¸æ¯”äºäº‘ç«¯çš„å¤§æ¨¡å‹ï¼Œç«¯ä¾§å¤§æ¨¡å‹å¤„ç†å¤æ‚é—®é¢˜èƒ½åŠ›ä¸è¶³ï¼Œæ‰€ä»¥ç«¯ä¾§å’Œäº‘ç«¯åº”è¯¥æ˜¯ç›¸è¾…ç›¸æˆçš„ã€‚è½»é‡çº§ä»»åŠ¡ç»™ç«¯ä¾§ï¼Œéœ€è¦é•¿é€»è¾‘ç†è§£çš„ä»»åŠ¡äº¤ç»™äº‘ç«¯ã€‚
ç«¯ä¾§å’Œäº‘çš„ååŒå·¥ä½œï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ç ”ç©¶æ–¹å‘ã€‚
0x01 Deja Vu 1. é—®é¢˜åˆ†æå’ŒåŠ¨æœº ä½œè€…é€šè¿‡åˆ†æOPT-175Bæ¨¡å‹çš„ä¸Šä¸‹æ–‡ç¨€ç–æ€§å‘ç°å¯¹äºå¤§éƒ¨åˆ†çš„Transformer Layerï¼Œä»–ä»¬çš„ç¨€ç–æ€§éƒ½åœ¨85%å·¦å³ã€‚ä¸Šä¸‹æ–‡ç¨€ç–æ€§å°±æ˜¯ï¼šå¯¹äºç‰¹å®šçš„è¾“å…¥ï¼Œä»…æœ‰ä¸€å°éƒ¨åˆ†çš„æ¨¡å‹å‚æ•°å¯¹æœ€ç»ˆç»“æœæœ‰ç€é‡è¦çš„å½±å“ã€‚ å¦‚å›¾1-3æ‰€ç¤ºï¼š
Fig 1. Contextual SparsityDeja Vu: Contextual Sparsity for Efficient LLMs at Inference Time
Fig 3. Contextual sparsity in Attention HeadDeja Vu: Contextual Sparsity for Efficient LLMs at Inference Time...</p>
  </div>
  <footer class="entry-footer"><span title='2024-09-22 00:00:00 +0000 UTC'>September 22, 2024</span>&nbsp;Â·&nbsp;2 min&nbsp;Â·&nbsp;chenghua.Wang</footer>
  <a class="entry-link" aria-label="post link to ã€æ–½å·¥ä¸­ã€‘ç«¯ä¾§å¤§æ¨¡å‹æ¨ç†-ç®—æ³•-Part1: Deja Vu, LLM in a Flash" href="https://chenghuawang.github.io/keep-moving-forward/tech/edgellms-algorithms-part-1/"></a>
</article>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2 class="entry-hint-parent">Q8_0 @ Q4_0_4 GEMM/GEMV in llama.cpp
    </h2>
  </header>
  <div class="entry-content">
    <p>GEMM/GEMV in MLLM Slides
åœ¨æœ¬æ–‡ä¸­æˆ‘ä»¥mllmçš„å®ç°ä¸ºä¾‹ã€‚mllmä¸­çš„å¤§éƒ¨åˆ†æ··åˆç²¾åº¦çš„çŸ©é˜µä¹˜æ³•æ˜¯ä»llama.cppä¸­æ›´æ”¹è¿‡æ¥çš„ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹Q8_0å’ŒQ4_0ä»£è¡¨ä»€ä¹ˆã€‚Huggingfaceçš„Docä¸­ç»™å‡ºäº†ä¸€å¼ è¡¨ï¼Œå¤§å®¶å¯ä»¥å»çœ‹ä¸€ä¸‹ï¼šGGUF Quantization Typeï¼Œæˆ‘åœ¨è¿™é‡Œä¹Ÿæˆªå›¾ç»™å‡ºæ¥
Fig 1. Q8_0å’ŒQ4_0å«ä¹‰GGUF Quantization Type FROM Huggingface
å¯¹äºé‡åŒ–æ“ä½œä¸æ˜¯å¾ˆç†Ÿæ‚‰çš„è¯»è€…å¯ä»¥çœ‹ä¸‹æˆ‘ä¹‹å‰çš„blog: [Fundamental] æ¨¡å‹é‡åŒ–
åœ¨mllmä¸­ï¼ŒQ8_0å’ŒQ4_0çš„å®ç°æ˜¯è¿™æ ·çš„ï¼š
typedef struct { mllm_fp16_t d; // delta int8_t qs[QK8_0]; // quants QK8_0 = 32 } block_q8_0; // QK4_0 = 32 typedef struct { mllm_fp16_t d; // delta uint8_t qs[QK4_0 / 2]; // nibbles / quants } block_q4_0; è€ŒQ4_0x4å®é™…ä¸Šå°±æ˜¯å°†4ä¸ªQ4_0æ‰“åŒ…æˆä¸€ç»„ï¼Œè¿™æ ·åœ¨GEMMçš„æ—¶å€™å¯ä»¥åˆ©ç”¨èµ·æŒ‡ä»¤å¹¶è¡Œæ€§ã€‚
æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ä¸‹GEMVé—®é¢˜å®šä¹‰ï¼Œç„¶åå†æ¨å¹¿åˆ°GEMMä¸Šã€‚æˆ‘ä»¬æœ‰ä¸¤ä¸ªçŸ©é˜µï¼Œåˆ†åˆ«æ˜¯A($1 \times nr$), B($nc \times nr$)ï¼ŒçŸ©é˜µä¹˜æ³•åçš„ç»“æœæ˜¯C$1 \times nc$ã€‚ä¸€ä¸ªä¸æ˜¯éå¸¸æ°å½“çš„å›¾ä¾‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
Fig 2. Q8_0å’ŒQ4_0x4çš„GEMV ä¸ºäº†æ›´å¥½çš„ç†è§£æ€ä¹ˆåˆ†å—ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹Q4_0x4çš„æ•°æ®æ’å¸ƒæ˜¯æ€ä¹ˆæ ·çš„ï¼šQ4_0x4å®é™…ä¸Šæ˜¯åœ¨$nc$çš„æ–¹å‘ä¸Šä»¥4åˆ†å—ï¼Œåœ¨$nr$çš„æ–¹å‘ä¸Šä»¥32åˆ†å—ï¼Œæœ€ç»ˆå¾—åˆ°çš„blockå½¢çŠ¶å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
Fig 3. Q8_0å’ŒQ4_0x4çš„GEMV Tiled æˆ‘ä»¬åœ¨$nc$çš„æ–¹å‘ä¸Šä»¥4åˆ†å—ï¼Œåœ¨$nr$çš„æ–¹å‘ä¸Šä»¥32åˆ†å—ï¼Œå°†gemvæ‹†è§£æˆä¸€ä¸ªæ›´å°çš„å­é—®é¢˜ã€‚...</p>
  </div>
  <footer class="entry-footer"><span title='2024-09-17 00:00:00 +0000 UTC'>September 17, 2024</span>&nbsp;Â·&nbsp;3 min&nbsp;Â·&nbsp;chenghua.Wang</footer>
  <a class="entry-link" aria-label="post link to Q8_0 @ Q4_0_4 GEMM/GEMV in llama.cpp" href="https://chenghuawang.github.io/keep-moving-forward/tech/q8_0_q4_0_4_gemm_in_llamacpp/"></a>
</article>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2 class="entry-hint-parent">[Fundamental] FlashDecoding Series
    </h2>
  </header>
  <div class="entry-content">
    <p>0x00 å‰æ²¿å’Œé˜…è¯»ææ–™ FlashDecodingç³»åˆ—çš„æ–‡ç« æ˜¯å¯¹FAåœ¨æ¨ç†åœºæ™¯ä¸‹çš„æ”¹è¿›ï¼Œç›®å‰åŒ…å«ä¸¤ç¯‡æ–‡ç« ï¼š
Flash-Decoding for long-context inference, Torchå›¢é˜Ÿçš„Blog FlashDecoding&#43;&#43;: Faster Large Language Model Inference on GPUs æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨FA2ä¸­ç‰¹åˆ«å¯¹Seqæ–¹å‘åšäº†å¹¶è¡ŒåŒ–ï¼Œä½†æ˜¯åœ¨æ¨ç†çš„æ—¶å€™Seq=1ã€‚æ­¤æ—¶ï¼Œå¹¶ä¸èƒ½å ç”¨æ»¡GPUçš„å…¨éƒ¨çš„SMï¼Œå¯¼è‡´æ€§èƒ½æŸå¤±ï¼ŒFlashDecodingå°±æ˜¯å¯¹æ­¤çš„ä¼˜åŒ–ã€‚
0x01 FlashDecoding åœ¨è§£ç è¿‡ç¨‹ä¸­ï¼Œç”Ÿæˆçš„æ¯ä¸ªæ–°Tokenéƒ½éœ€è¦è€ƒè™‘ä¹‹å‰çš„æ‰€æœ‰Tokenï¼Œä»¥ä¾¿è¿›è¡Œæ³¨æ„åŠ›è®¡ç®—ã€‚
åœ¨è®­ç»ƒçš„æ—¶å€™ï¼ŒAttentionè¿™ä¸€ç®—å­å·²ä½¿ç”¨FlashAttentionV2ç®—æ³•è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå…¶ç“¶é¢ˆåœ¨äºè¯»å†™ä¸­é—´ç»“æœï¼ˆä¾‹å¦‚ Q @ K^Tï¼‰çš„å†…å­˜å¸¦å®½ä¸è¶³ã€‚ä½†æ˜¯ï¼Œè¿™äº›ä¼˜åŒ–å¹¶ä¸èƒ½ç›´æ¥åº”ç”¨äºæ¨ç†ï¼Œå› ä¸ºæ¨ç†çš„æ—¶å€™ä¸åœ¨æ˜¯å†…å­˜å¸¦å®½çš„ç“¶é¢ˆã€‚åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼ŒFlashAttention ä¼šåœ¨Batchå’ŒSeqä¸¤ä¸ªç»´åº¦ä¸Šè¿›è¡Œå¹¶è¡Œå¤„ç†ã€‚åœ¨æ¨ç†è¿‡ç¨‹ä¸­ï¼ŒSeq=1ï¼Œè¿™æ„å‘³ç€ï¼Œå¦‚æœBatchå¤§å°å°äº GPU ä¸Šçš„SMæ•°é‡ï¼ˆA100 ä¸º 108ï¼‰ï¼Œåˆ™è¿™ä¸ªAttentionæ“ä½œåªä¼šä½¿ç”¨ GPU çš„ä¸€å°éƒ¨åˆ†ï¼åœ¨ä½¿ç”¨é•¿ä¸Šä¸‹æ–‡æ—¶å°¤å…¶å¦‚æ­¤ã€‚å½“Batchå¤§å°ä¸º 1 æ—¶ï¼ŒFlashAttention å°†ä½¿ç”¨ä¸åˆ° 1%çš„ GPUï¼
Fig 1. Regular AttentionFlash-Decoding for long-context inference
ä¸ºæ­¤æˆ‘ä»¬ä¸éš¾æƒ³åˆ°å¯ä»¥å®ç”¨Split-Kçš„æ–¹æ³•æ¥ä½¿å¾—Attentionåœ¨æ¨ç†çš„æ—¶å€™ä¹Ÿæœ‰å¾ˆå¥½çš„å¹¶è¡Œæ€§ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
Fig 1. Split-K AttentionFlash-Decoding for long-context inference
éå¸¸çš„å¥½ç†è§£ï¼Œä½†æ˜¯è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨æœ€åçš„Reduce Opè¿™é‡Œè¿˜æ˜¯è¦åšOnline Softmaxçš„ï¼Œæ‰€ä»¥åœ¨SRAMé‡Œé¢ä¿å­˜çš„ä¸œè¥¿æ˜¯æ¯”åŸæ¥å¤šçš„ï¼Œé™¤äº†Outputï¼Œè¿˜æœ‰exp Sumå’ŒMaxã€‚
0x02 FlashDecoding&#43;&#43; flashdecoding&#43;&#43;ä¸æ˜¯metaå®˜æ–¹å‡ºå“çš„ã€‚
FAä¸­ï¼Œæ±‚è§£Maxéœ€è¦éå†è¿­ä»£ï¼Œä¹‹åçš„å­å—ä¾èµ–äºä¹‹å‰çš„å­å—ã€‚Safe-softmaxçš„è®¡ç®—å…¬å¼ä¸­ï¼Œéœ€è¦å…ˆæ±‚æ¯è¡Œxçš„æœ€å¤§å€¼ï¼Œç„¶åå‡å»è¿™ä¸ªmax(x)ä¹‹åï¼Œå†åšsoftmaxä»¥é˜²æ­¢æ•°å€¼æº¢å‡ºã€‚FlashDecoding&#43;&#43;æå‡ºçš„åˆ›æ–°ç‚¹å°±æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥å®ç”¨ä¸€ä¸ªå…ˆéªŒçš„$\phi$æ¥ä½œä¸ºmaxå€¼ï¼Œåªè¦å®ƒèƒ½è®©æ•°å€¼ç¨³å®šå°±å¯ä»¥äº†ã€‚ä»Safe Softmaxçš„å…¬å¼ä¸Šæ¥çœ‹ï¼Œæ— è®ºæ˜¯$\phi$è¿˜æ˜¯max(x)ï¼Œä»–ä»¬çš„ç»“æœæ˜¯ä¸€è‡´çš„ï¼Œæˆ‘ä»¬éœ€è¦è¿½æ±‚çš„æ˜¯æ•°å€¼ä¸Šçš„ç¨³å®šä¸å¦ã€‚
FlashDecoding&#43;&#43;è®¤ä¸ºä¸€ä¸ªåˆç†çš„å…ˆéªŒå€¼ $\phi$ï¼Œå¯ä»¥ç›´æ¥ä»æ•°æ®é›†ä¸­è¿›è¡Œç»Ÿè®¡è·å¾—ã€‚å¯¹äºä¸åŒçš„æ¨¡å‹ï¼Œè¿™ä¸ªå…ˆéªŒå€¼ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ã€‚åœ¨å®ç°çš„æ—¶å€™ï¼ŒFlashDecoding&#43;&#43;è¿˜ä½¿ç”¨äº†Fallbackçš„æ€è·¯ï¼Œå½“å‡ºç°æ•°å€¼æº¢å‡ºçš„æ—¶å€™ï¼Œä½¿ç”¨ä¼ ç»Ÿçš„FlashDecodingã€‚
é‚£ä¸ºä»€ä¹ˆFalshDecoding&#43;&#43;èƒ½å¼‚æ­¥ï¼Œè€ŒFlashDecodingä¸è¡Œå‘¢ï¼Ÿ
åœ¨FalshDecoding Split-Kåˆ†æˆçš„å‡ ä¸ªåŒºé—´å†…ï¼Œè¿˜æ˜¯ä½¿ç”¨çš„FA2çš„æ–¹æ³•æ¥è®¡ç®—ï¼Œä½†æ˜¯FA2çš„ä¸€æ¬¡è¿­ä»£æ˜¯ä¾èµ–äºä¸Šä¸€æ¬¡è¿­ä»£çš„ç»“æœçš„ï¼Œä¹Ÿå°±æ˜¯éœ€è¦rescaleã€‚ä½†æ˜¯FlashDecoding&#43;&#43;ä¸éœ€è¦ï¼Œå®ƒå¤§è‡´ä¸Šæ˜¯è¿™æ ·çš„ï¼š
$$\begin{aligned} &amp;\ell^{(1)}=\mathrm{rowsum}\Big(e^{\mathbf{S}^{(1)}-\phi}\Big)\in\mathbb{R}^{B_{r}} \\ &amp;\tilde{\mathbf{O}}^{(1)}=e^{\mathbf{S}^{(1)}-\phi}\mathbf{V}^{(1)}\in\mathbb{R}^{B_{r}\times d} \\ &amp;\ell^{(2)}=\mathrm{rowsum}\left(e^{\mathbf{S}^{(2)}-\phi}\right) \\ &amp;\tilde{\mathbf{O}}^{(2)}=e^{s^{(2)}-\phi}\mathbf{V}^{(2)} \\ &amp;\mathbf{O}^{(2)}=\mathrm{diag}\left(\ell^{(1)}&#43;\ell^{(2)}\right)^{-1}(\tilde{\mathbf{O}}^{(1)}&#43;\tilde{\mathbf{O}}^{(2)})=\mathbf{O} \end{aligned}$$ </p>
  </div>
  <footer class="entry-footer"><span title='2024-08-21 00:00:00 +0000 UTC'>August 21, 2024</span>&nbsp;Â·&nbsp;1 min&nbsp;Â·&nbsp;chenghua.Wang</footer>
  <a class="entry-link" aria-label="post link to [Fundamental] FlashDecoding Series" href="https://chenghuawang.github.io/keep-moving-forward/tech/fundamental_flashdecoding_series/"></a>
</article>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2 class="entry-hint-parent">[Fundamental] æ¨¡å‹é‡åŒ–
    </h2>
  </header>
  <div class="entry-content">
    <p>RoPE from Fundamental Series</p>
  </div>
  <footer class="entry-footer"><span title='2024-08-19 00:00:00 +0000 UTC'>August 19, 2024</span>&nbsp;Â·&nbsp;4 min&nbsp;Â·&nbsp;chenghua.Wang</footer>
  <a class="entry-link" aria-label="post link to [Fundamental] æ¨¡å‹é‡åŒ–" href="https://chenghuawang.github.io/keep-moving-forward/tech/fundamental_quantization/"></a>
</article>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2 class="entry-hint-parent">âœ…[April-May 2024] æ¨¡å‹é‡åŒ–ä¹‹ ğŸ¥•Quarot &amp; SpinQuant
    </h2>
  </header>
  <div class="entry-content">
    <p>0. å‰è¨€ æœ¬é—®åˆ†æçš„ä¸¤ç¯‡æ–‡ç« æ˜¯ï¼š
2024-05, SpinQuant: LLM quantization with learned rotations from metaï¼Œä¸€ä½œæ˜¯ Zechun Liu
2024-04, QuaRot: Outlier-Free 4-Bit Inference in Rotated LLMs from ETH Zurichã€EPFLã€Microsoft Researchã€IST Austria &amp; NeuralMagic
è¿™ä¸¤ç¯‡æ–‡ç« ä»¥ç›¸åŒçš„è§†è§’å»è§£å†³é—®é¢˜ï¼Œå¹¶ä¸”é‡åŒ–åçš„æ¨¡å‹ä¿æŒäº†ç›¸å½“å¥½çš„æ€§èƒ½ï¼Œåº”è¯¥å°±æ˜¯æœªæ¥æ¨¡å‹é‡åŒ–çš„ä¸€ä¸ªä¸»è¦çš„è·Ÿè¿›æ–¹å‘ã€‚QuaRotå’ŒSpinQuantå¯ä»¥ç®—ä½œæ˜¯åŒä¸€ç³»åˆ—çš„å·¥ä½œï¼ŒSpinQuantåœ¨QuaRotçš„åŸºç¡€ä¸Šåšäº†å¯å­¦ä¹ æ—‹è½¬çŸ©é˜µçš„æ”¹è¿›ã€‚
1. Computational Invariance Computational Invarianceæ˜¯Quarotå’ŒSpinQuantçš„åŸºç¡€ã€‚
Computational Invarianceå®šç†[1]æŒ‡å‡ºï¼Œå¯ä»¥ä½¿ç”¨æ­£äº¤çŸ©é˜µå¯¹Transformer ä¸­çš„æƒé‡å’Œå—é—´æ¿€æ´»è¿›è¡Œå˜æ¢ï¼Œè€Œæ¨¡å‹è¾“å‡ºä¸å˜ã€‚è¿™ä¸ªå®šç†æ˜¯è¯´ï¼Œå¦‚æœ$W_{in}$æ˜¯ä¸€ä¸ªåœ¨transformer block(i.e. $W_k,W_q,W_v$ç­‰)å·¦è¾¹çš„æƒé‡ï¼Œæˆ‘ä»¬å¯ä»¥å·¦ä¹˜ä¸Šä¸€ä¸ªæ­£äº¤çš„çŸ©é˜µ$Q$ï¼Œä¸ºäº†åœ¨æœ€åçš„ç»“æœé‡Œæ¶ˆé™¤è¿™ä¸ªå½±å“ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¾“å‡ºçŸ©é˜µ(i.e. $W_{out}, W_{down}$)å³è¾¹ä¹˜ä¸Š$Q_T$ã€‚
å°½ç®¡ RMSNorm è¢«åº”ç”¨äºä¸¤ä¸ªæ•°æ®å—ä¹‹é—´ï¼Œä½†åªè¦ RMSNorm æ•°æ®å—ä¸­æ²¡æœ‰é‡æ–°ç¼©æ”¾ï¼ˆåœ¨å®é™…æ“ä½œä¸­ï¼Œæˆ‘ä»¬ä¼šå…ˆå°†ä»»ä½•é‡æ–°ç¼©æ”¾å¸æ”¶åˆ°ç›¸é‚»çš„æƒé‡çŸ©é˜µä¸­ï¼‰ï¼Œè¿™ä¸€ç‚¹è¿˜æ˜¯é€‚ç”¨çš„ã€‚ä»æ¦‚å¿µä¸Šè®²ï¼Œè¿™æ˜¯å› ä¸º RMSNorm å°†æ¿€æ´»å€¼é™¤ä»¥å®ƒä»¬çš„æ¨¡é•¿ï¼Œè€Œå¯¹æ¿€æ´»å€¼åº”ç”¨æ—‹è½¬çŸ©é˜µ$Q$ä¸ä¼šå½±å“æ¨¡é•¿ï¼ˆå› ä¸ºæ­£äº¤çŸ©é˜µçš„ç‰¹æ€§ï¼‰ï¼š
$$\text{RMSNorm}(\boldsymbol{X}) = \text{RMSNorm}(\boldsymbol{X\boldsymbol{Q}^T})\boldsymbol{Q}$$
æˆ‘ä»¬è¿™é‡Œå‡è®¾RMSNormå¯¹æ¿€æ´»å€¼$\boldsymbol{X}$çš„æ¯ä¸€è¡Œåšçš„æ“ä½œéƒ½æ˜¯$x_{i} \larr x_i/ \Vert x_I \Vert$ã€‚è¿™æ„å‘³ç€ï¼Œå°†è¾“å‡ºçŸ©é˜µä¹˜ä»¥ $Q^T$ ä¼šä½¿çº¿æ€§å±‚è¾“å‡º$XQ^T$ï¼Œ$XQ^T$è¢«å½’ä¸€åŒ–ï¼Œç„¶åä¼ å…¥ä¸‹ä¸€ä¸ªåŒºå—ï¼Œå…¶è¾“å…¥æƒé‡çŸ©é˜µç°åœ¨æ˜¯$QW$ï¼Œå› æ­¤è¯¥çº¿æ€§å±‚ä¸åšä»»ä½•ä¿®æ”¹å°±ä¼šè¾“å‡ºåŸå§‹æ¿€æ´»ã€‚
2. ğŸ¥•Quarot Quarotæœ‰ä¸¤ä¸ªé˜¶æ®µï¼Œä¸€ä¸ªé˜¶æ®µæ˜¯åœ¨å…¨ç²¾åº¦ä¸‹æ“ä½œæ¨¡å‹æƒé‡ï¼Œå¹¶åœ¨æ¨¡å‹çš„å‰å‘ä¼ é€’ä¸­æ’å…¥ä¸¤ä¸ªé¢å¤–çš„ä¹˜HadamardçŸ©é˜µæ“ä½œï¼›åœ¨ç¬¬äºŒä¸ªé˜¶æ®µä½¿ç”¨ç°åœ¨çš„é‡åŒ–æ–¹æ³•æ¥é‡åŒ–å¤¹åœ¨HadamardçŸ©é˜µä¸­çš„æ¨¡å‹æƒé‡ï¼Œå› ä¸ºè¿™äº›æƒé‡è¢«å‰Šå‡äº†å³°åº¦ï¼Œoutlierså‡å°‘ï¼Œå¯ä»¥ä½¿é‡åŒ–çš„å‹åŠ›å°å¾ˆå¤šã€‚
Fig 1. QuaRot workflow 1 Fig 2. QuaRot workflow 2 Quarotæ–‡ä¸­çš„å›¾ç‰‡å·²ç»éå¸¸æ¸…æ™°çš„æç»˜äº†ä»€ä¹ˆæ—¶å€™åšæ—‹è½¬ä»¥åŠä½•æ—¶åšé‡åŒ–å’Œé‡åŒ–çš„æ•°æ®æµã€‚SpinQuantå’ŒQuarotæ¯”è¾ƒäº†å®éªŒç»“æœï¼ŒQuarotçš„å®éªŒç»“æœè¯·çœ‹ç¬¬ä¸‰ç« èŠ‚çš„SpinQuantçš„è¡¨æ ¼ã€‚...</p>
  </div>
  <footer class="entry-footer"><span title='2024-08-15 00:00:00 +0000 UTC'>August 15, 2024</span>&nbsp;Â·&nbsp;2 min&nbsp;Â·&nbsp;chenghua.Wang</footer>
  <a class="entry-link" aria-label="post link to âœ…[April-May 2024] æ¨¡å‹é‡åŒ–ä¹‹ ğŸ¥•Quarot &amp; SpinQuant" href="https://chenghuawang.github.io/keep-moving-forward/papers/quant_quarot_spinquant/"></a>
</article>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2 class="entry-hint-parent">mllmæ¡†æ¶æµ…æ(äºŒ)-QNN-Backend
    </h2>
  </header>
  <div class="entry-content">
    <p>ä»¥Qwen0.5Bä¸ºä¾‹è§£æmllmçš„åŸºæœ¬å®ç°ï¼ŒNPU Backend</p>
  </div>
  <footer class="entry-footer"><span title='2024-08-13 00:00:00 +0000 UTC'>August 13, 2024</span>&nbsp;Â·&nbsp;6 min&nbsp;Â·&nbsp;chenghua.Wang</footer>
  <a class="entry-link" aria-label="post link to mllmæ¡†æ¶æµ…æ(äºŒ)-QNN-Backend" href="https://chenghuawang.github.io/keep-moving-forward/tech/mllm-qwen-2/"></a>
</article>
<footer class="page-footer">
  <nav class="pagination">
    <a class="next" href="https://chenghuawang.github.io/keep-moving-forward/categories/aisys/page/2/">Next&nbsp;2/3&nbsp;Â»
    </a>
  </nav>
</footer>
    </main>
    
<footer class="footer">
        <span>Â© <a href="https://github.com/chenghuaWang">chenghua.wang</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a><script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
const images = Array.from(document.querySelectorAll(".post-content img"));
images.forEach(img => {
  mediumZoom(img, {
    margin: 0,  
    scrollOffset: 40,  
    container: null,  
    template: null,  
    background: 'rgba(0, 0, 0, 0.8)'
  });
});
</script>
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5j20jf9ml5x&amp;m=0&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33" async="async"></script>


<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
