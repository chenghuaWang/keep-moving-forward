<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>MapReduce | Ubios Home</title>
<meta name="keywords" content="">
<meta name="description" content="OSDI&#39;04: 6th Symposium on Operating Systems Design and Implementation
go back to home
Paper link
什么是 MapReduce 在MapReduce原文中是这么说的
MapReduce is a programming model and an associated implementation for processing and generating large data sets. [1]
这是一个较为简单的处理大型问题的分布式编程模型。其产生的原因是因为 google 想要让普通的程序员也能够通过一套简单的编程模型来编写分布式应用程序，以此来处理 google 内部的大数据。然后著名的 Jeff Dean 和 Sanjay Ghemawat 出马搞定了这个问题(在知乎上关于Jeff Dean的轶事:-))。MapReduce 在 google 内部运行很长的时间并且处理了很多业务，但是目前也败下阵来，具体原因参见 MapReduce 缺陷章节(MR早在2004年就出来了，其实是古早的技术了，其没有在性能上做文章，主要在可扩展性上)。
MapReduce 的设计框架和基本流程 MR实际上是一个非常简单的框架，思路也非常的直白。MapReduce 背后的核心思想是将数据集映射到一个 &lt;key, value&gt; pair的集合中，然后使用相同的键对所有pair进行整合。 整体概念很简单，但是如果你设想下下面的情况，MR实际上非常有用: 基本上所有的数据都能被映射到一个 &lt;key, value&gt; 对中，并且key和value可以是任意类型。
在论文中MR使用的样例是在超大的文件里做单词统计。这个框架还可以用来做：
分布式的排序 分布式的搜索 Web链接图遍历 &hellip; Fig 1.">
<meta name="author" content="chenghua.Wang">
<link rel="canonical" href="https://chenghuawang.github.io/keep-moving-forward/papers/mapreduce/">
<link crossorigin="anonymous" href="/keep-moving-forward/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://chenghuawang.github.io/keep-moving-forward/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://chenghuawang.github.io/keep-moving-forward/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://chenghuawang.github.io/keep-moving-forward/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://chenghuawang.github.io/keep-moving-forward/apple-touch-icon.png">
<link rel="mask-icon" href="https://chenghuawang.github.io/keep-moving-forward/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://chenghuawang.github.io/keep-moving-forward/papers/mapreduce/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          
          
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
          ],
          
          throwOnError : false
        });
    });
</script>



  

<meta property="og:title" content="MapReduce" />
<meta property="og:description" content="OSDI&#39;04: 6th Symposium on Operating Systems Design and Implementation
go back to home
Paper link
什么是 MapReduce 在MapReduce原文中是这么说的
MapReduce is a programming model and an associated implementation for processing and generating large data sets. [1]
这是一个较为简单的处理大型问题的分布式编程模型。其产生的原因是因为 google 想要让普通的程序员也能够通过一套简单的编程模型来编写分布式应用程序，以此来处理 google 内部的大数据。然后著名的 Jeff Dean 和 Sanjay Ghemawat 出马搞定了这个问题(在知乎上关于Jeff Dean的轶事:-))。MapReduce 在 google 内部运行很长的时间并且处理了很多业务，但是目前也败下阵来，具体原因参见 MapReduce 缺陷章节(MR早在2004年就出来了，其实是古早的技术了，其没有在性能上做文章，主要在可扩展性上)。
MapReduce 的设计框架和基本流程 MR实际上是一个非常简单的框架，思路也非常的直白。MapReduce 背后的核心思想是将数据集映射到一个 &lt;key, value&gt; pair的集合中，然后使用相同的键对所有pair进行整合。 整体概念很简单，但是如果你设想下下面的情况，MR实际上非常有用: 基本上所有的数据都能被映射到一个 &lt;key, value&gt; 对中，并且key和value可以是任意类型。
在论文中MR使用的样例是在超大的文件里做单词统计。这个框架还可以用来做：
分布式的排序 分布式的搜索 Web链接图遍历 &hellip; Fig 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chenghuawang.github.io/keep-moving-forward/papers/mapreduce/" /><meta property="article:section" content="papers" />
<meta property="article:published_time" content="2023-01-17T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-01-17T00:00:00+00:00" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MapReduce"/>
<meta name="twitter:description" content="OSDI&#39;04: 6th Symposium on Operating Systems Design and Implementation
go back to home
Paper link
什么是 MapReduce 在MapReduce原文中是这么说的
MapReduce is a programming model and an associated implementation for processing and generating large data sets. [1]
这是一个较为简单的处理大型问题的分布式编程模型。其产生的原因是因为 google 想要让普通的程序员也能够通过一套简单的编程模型来编写分布式应用程序，以此来处理 google 内部的大数据。然后著名的 Jeff Dean 和 Sanjay Ghemawat 出马搞定了这个问题(在知乎上关于Jeff Dean的轶事:-))。MapReduce 在 google 内部运行很长的时间并且处理了很多业务，但是目前也败下阵来，具体原因参见 MapReduce 缺陷章节(MR早在2004年就出来了，其实是古早的技术了，其没有在性能上做文章，主要在可扩展性上)。
MapReduce 的设计框架和基本流程 MR实际上是一个非常简单的框架，思路也非常的直白。MapReduce 背后的核心思想是将数据集映射到一个 &lt;key, value&gt; pair的集合中，然后使用相同的键对所有pair进行整合。 整体概念很简单，但是如果你设想下下面的情况，MR实际上非常有用: 基本上所有的数据都能被映射到一个 &lt;key, value&gt; 对中，并且key和value可以是任意类型。
在论文中MR使用的样例是在超大的文件里做单词统计。这个框架还可以用来做：
分布式的排序 分布式的搜索 Web链接图遍历 &hellip; Fig 1."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Papers",
      "item": "https://chenghuawang.github.io/keep-moving-forward/papers/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "MapReduce",
      "item": "https://chenghuawang.github.io/keep-moving-forward/papers/mapreduce/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "MapReduce",
  "name": "MapReduce",
  "description": "OSDI'04: 6th Symposium on Operating Systems Design and Implementation\ngo back to home\nPaper link\n什么是 MapReduce 在MapReduce原文中是这么说的\nMapReduce is a programming model and an associated implementation for processing and generating large data sets. [1]\n这是一个较为简单的处理大型问题的分布式编程模型。其产生的原因是因为 google 想要让普通的程序员也能够通过一套简单的编程模型来编写分布式应用程序，以此来处理 google 内部的大数据。然后著名的 Jeff Dean 和 Sanjay Ghemawat 出马搞定了这个问题(在知乎上关于Jeff Dean的轶事:-))。MapReduce 在 google 内部运行很长的时间并且处理了很多业务，但是目前也败下阵来，具体原因参见 MapReduce 缺陷章节(MR早在2004年就出来了，其实是古早的技术了，其没有在性能上做文章，主要在可扩展性上)。\nMapReduce 的设计框架和基本流程 MR实际上是一个非常简单的框架，思路也非常的直白。MapReduce 背后的核心思想是将数据集映射到一个 \u0026lt;key, value\u0026gt; pair的集合中，然后使用相同的键对所有pair进行整合。 整体概念很简单，但是如果你设想下下面的情况，MR实际上非常有用: 基本上所有的数据都能被映射到一个 \u0026lt;key, value\u0026gt; 对中，并且key和value可以是任意类型。\n在论文中MR使用的样例是在超大的文件里做单词统计。这个框架还可以用来做：\n分布式的排序 分布式的搜索 Web链接图遍历 \u0026hellip; Fig 1.",
  "keywords": [
    
  ],
  "articleBody": "OSDI'04: 6th Symposium on Operating Systems Design and Implementation\ngo back to home\nPaper link\n什么是 MapReduce 在MapReduce原文中是这么说的\nMapReduce is a programming model and an associated implementation for processing and generating large data sets. [1]\n这是一个较为简单的处理大型问题的分布式编程模型。其产生的原因是因为 google 想要让普通的程序员也能够通过一套简单的编程模型来编写分布式应用程序，以此来处理 google 内部的大数据。然后著名的 Jeff Dean 和 Sanjay Ghemawat 出马搞定了这个问题(在知乎上关于Jeff Dean的轶事:-))。MapReduce 在 google 内部运行很长的时间并且处理了很多业务，但是目前也败下阵来，具体原因参见 MapReduce 缺陷章节(MR早在2004年就出来了，其实是古早的技术了，其没有在性能上做文章，主要在可扩展性上)。\nMapReduce 的设计框架和基本流程 MR实际上是一个非常简单的框架，思路也非常的直白。MapReduce 背后的核心思想是将数据集映射到一个 pair的集合中，然后使用相同的键对所有pair进行整合。 整体概念很简单，但是如果你设想下下面的情况，MR实际上非常有用: 基本上所有的数据都能被映射到一个 对中，并且key和value可以是任意类型。\n在论文中MR使用的样例是在超大的文件里做单词统计。这个框架还可以用来做：\n分布式的排序 分布式的搜索 Web链接图遍历 … Fig 1. MapReduce Archfrom “MapReduce: Simplified Data Processing on Large Clusters” googleusercontent.com.\nMR 中的Map和Reduce是从函数式编程语言(LISP)中借鉴过来的一个概念。程序员只需要编写Map和Reduce两个函数就能够对某个任务并发处理。在 Fig 1 中，MR主要的流程分为6个部分\n用户程序的MR首先将输入文件分成 M 块，每块通常为 16 MB到 64 MB(可由用户通过参数控制)。 然后，它会在一组机器上启动该程序的多个副本。\n这些副本中有一个控制程序(Master)。其余的程序(Worker)由控制程序(Master)来分配。有 M 个 Map 任务和 R 个 Reduce 任务要分配。Master 挑选空闲的 Worker 并为每个机器分配一个 Map 任务或 Reduce 任务。\n分配了 map 任务的 worker 读取相应的内容(拆分后的文件块)(设想下，如果这里的文件读取需要从数据仓库中拿出，那么整个框架的计算能力极大的被网络所限制了)。它从输入数据中解析出对，并将每一对传递给用户定义的 Map 函数。 Map 函数产生的中间对被缓存在内存中。\n缓存在机器中的中间对周期性地被写入本地磁盘，由分区函数划分为 R 个区域。这些缓冲对在本地磁盘上的位置被传回 Master，Master 负责将这些位置转发给 Reduce Worker。\n当 Master 通知 Reduce Worker 有关这些位置时，它会使用RPC从 Map Worker 的本地磁盘读取缓冲数据。当 Reduce Worker 读取所有中间数据时，它会按中间键对其进行排序，以便将所有出现的相同键组合在一起。排序是因为通常许多不同的键映射到同一个 Reduce 任务。如果中间数据量太大而无法放入内存，则使用外部排序。\nReduce Worker 迭代排序的中间数据，对于遇到的每个唯一中间键，它将键和相应的中间值集传递给用户的 Reduce 函数。Reduce 函数的输出到此 Reduce 分区的最终输出文件。\n当所有的 Map 任务和 Reduce 任务都完成后，Master唤醒用户程序。此时用户程序中的 MR 调用返回给用户代码\n因为网络上的数据交换是非常缓慢的，作者在分发数据的时候尽量保证数据就在这台计算服务器上，而不需要传输数据。在原文中是这样说的：\nWe conserve network bandwidth by taking advantage of the fact that the input data (managed by GFS) is stored on the local disks of the machines that make up our cluster.\nMapReduce 的使用范例 论文中，以词频统计为例子，如论文中的伪代码：\nmap(String key, String value):\r// key: document name\r// value: document contents\rfor each word w in value:\rEmitIntermediate(w, \"1\"); reduce(String key, Iterator values):\r// key: a word\r// values: a list of counts\rint result = 0;\rfor each v in values:\rresult += ParseInt(v);\rEmit(AsString(result)); MR Fault Tolerance Fault Tolerance 在分布式程序中是非常重要的。MR 主要的贡献点其实就在 scalability 和 fault tolerance。\nWorker Failure Master 会定期的 ping Worker 服务器，如果不通，那么这个 Worker 被设置成 idle，分配给这台机器的任务会被分发给其他的机器。\nMaster Failure Master 因为只有少量的机器，所以发生错误的可能性非常的小。可以通过存储 Master 的状态为 checkpoints 来进行错误时回退和恢复。\nMR 缺陷 MR 的缺陷实际上在 Google I/O 上已经说明了，如下:\nToday at Google I/O, we are demonstrating Google Cloud Dataflow for the first time. Cloud Dataflow is a fully managed service for creating data pipelines that ingest, transform and analyze data in both batch and streaming modes. Cloud Dataflow is a successor to MapReduce, and is based on our internal technologies like Flume and MillWheel.[2]\nMR是一个基于 batch mode 的框架。 用 MR 写复杂的分析 pipeline 太麻烦。 在很多情况下，一次 MR 执行是没法把事情做完的，需要很多个 MR 任务互相组合，这就是 MR pipeline. 在数据流复杂的分析任务中，设计好的 pipeline 达到最高运行效率很困难。\nMR 最大的贡献我认为就是 scalability 和 fault tolerance。在 MillWheel 里，结果可以随着数据流的输入实时的显示出来，而不是到数据流结束时才输出一个结果，而且这样中间结果不需要保存下来。\nMR Lab in MIT6.824 Check the lab-mr page here\n在本实验中，我们将构建一个 MapReduce 系统。 我们将实现一个调用应用程序 Map 和 Reduce 函数并处理读写文件的程序，以及一个将任务分发给 Worker 并处理失败的 Worker 的进程(Master)。在 MR 实验中，使用 Golang 来编码实现。\n我的实现在 WSL Ubuntu20.04 上 go版本 1.18。\n这次的要求貌似比以前更难了，这次需要 Worker 主动向 Master 请求任务，当任务超时后，需要 Master 来重新分配这个任务。\n总体思路其实也非常的简单，worker 和 coordinator 的交互都围绕着 RPC 展开，故先从 RPC 的定义开始。因为深受事件轮询编程模式的’荼毒’，我把 worker 和 coordinator 之间的交互过程以事件的形式来进行处理。首先定义事件的类型。\n// src/mr/rpc.go type TaskTp = int const ( TpRequireTask = iota TpMapTaskDone TpReduceTaskDone TpSendMapTask TpSendReduceTask TpTaskAllDone TpWait ) 再来考虑 RPC 需要在 worker 和 coordinator 中传递什么信息？不论何种信息，首先都需要一个时间戳来记录 require 和 reply 对。其次每个 worker 都需要知道一共有多少个 Map 和 Reduce 任务。每个 require 需要跟上当前 worker 的任务编号。当然，因为是事件驱动的角度编写的，所以每条 require 和 reply 都需要有一个事件类型记录。\n// src/mr/rpc.go type RequireMsg struct { Stamp int64 MsgFlag TaskTp TaskID int } type ReplyMsg struct { Stamp int64 MsgFlag TaskTp TaskID int NumReduceWorkers int NumMapWorkers int Content string } 对于 coordinator，其作用像是一个状态机，需要维护所有的 worker 的状态，并能做到回退(Fault Tolerance)。Coordinator 的定义如下\n// src/mr/coordinator.go type Coordinator struct { nMapWorkers int nReduceWorkers int nMapWorking int nReduceWorking int MapWorkerState []int64 ReduceWorkerState []int64 FilesContent []string MapWorkerPool chan int ReduceWorkerPool chan int IsDone bool GlobalLock *sync.Cond // to make sure the rpc visit is atomic. } coordinator 需要处理 RPC 的请求，对于不同的事件进行反应。因为需要超时处理，所以在这里，每一个 worker 都会有一个协程来进行相应的计时和 id 回收。\n// src/mr/coordinator.go func (c *Coordinator) ProcessEvents(args *RequireMsg, reply *ReplyMsg) error { c.GlobalLock.L.Lock() tmpBool := c.IsDone c.GlobalLock.L.Unlock() if tmpBool { reply.MsgFlag = TpTaskAllDone reply.Stamp = args.Stamp return nil } switch args.MsgFlag { case TpMapTaskDone: c.GlobalLock.L.Lock() if c.MapWorkerState[args.TaskID] == args.Stamp { c.MapWorkerState[args.TaskID] = 1 c.nMapWorking-- } c.GlobalLock.L.Unlock() case TpReduceTaskDone: c.GlobalLock.L.Lock() if c.ReduceWorkerState[args.TaskID] == args.Stamp { c.ReduceWorkerState[args.TaskID] = 1 c.nReduceWorking-- } if c.nReduceWorking == 0 { c.IsDone = true } c.GlobalLock.L.Unlock() case TpRequireTask: if len(c.MapWorkerPool) \u003e 0 { // State 1. Send Map Task to worker. reply.Stamp = args.Stamp reply.TaskID = \u003c-c.MapWorkerPool reply.MsgFlag = TpSendMapTask reply.NumMapWorkers = c.nMapWorkers reply.NumReduceWorkers = c.nReduceWorkers reply.Content = c.FilesContent[reply.TaskID] c.GlobalLock.L.Lock() c.MapWorkerState[reply.TaskID] = args.Stamp c.GlobalLock.L.Unlock() go func(id int) { time.Sleep(10 * time.Second) c.GlobalLock.L.Lock() if c.MapWorkerState[id] != 1 { // run out of 10 secs. recycle this id to id pool. c.MapWorkerPool \u003c- id } c.GlobalLock.L.Unlock() }(reply.TaskID) return nil } else { c.GlobalLock.L.Lock() nMapOnWorking := c.nMapWorking nReduceOnWorking := c.nReduceWorking c.GlobalLock.L.Unlock() // State 2. All map worker is on working. wait. if nMapOnWorking != 0 { reply.Stamp = args.Stamp reply.TaskID = -1 reply.MsgFlag = TpWait reply.Content = \"Just Wait !!! Map Worker !!!\" reply.NumMapWorkers = c.nMapWorkers reply.NumReduceWorkers = c.nReduceWorkers } else { // State 3. Map is Done. Send Reduce task to works. if len(c.ReduceWorkerPool) \u003e 0 { reply.Stamp = args.Stamp reply.TaskID = \u003c-c.ReduceWorkerPool reply.MsgFlag = TpSendReduceTask reply.Content = \"Reduce no need to handle this\" reply.NumMapWorkers = c.nMapWorkers reply.NumReduceWorkers = c.nReduceWorkers c.GlobalLock.L.Lock() c.ReduceWorkerState[reply.TaskID] = args.Stamp c.GlobalLock.L.Unlock() go func(id int) { time.Sleep(10 * time.Second) c.GlobalLock.L.Lock() if c.ReduceWorkerState[id] != 1 { // run out of 10 secs. resolved this id to id pool. c.ReduceWorkerPool \u003c- id } c.GlobalLock.L.Unlock() }(reply.TaskID) } else { // State 4. All reduce worker is on working. wait. if nReduceOnWorking != 0 { reply.Stamp = args.Stamp reply.TaskID = -1 reply.MsgFlag = TpWait reply.Content = \"Just Wait !!! Reduce Worker !!!\" reply.NumMapWorkers = c.nMapWorkers reply.NumReduceWorkers = c.nReduceWorkers } } } } default: return nil } return nil } 同样的，在 worker 中的流程也是不断的循环产生事件，处理事件\n// src/mr/worker.go func Worker(mapf func(string, string) []KeyValue, reducef func(string, []string) string) { for true { ThisStamp := time.Now().Unix() Req := RequireMsg{} Req.Stamp = ThisStamp Req.MsgFlag = TpRequireTask Req.TaskID = -1 Rep := ReplyMsg{} ok := call(\"Coordinator.ProcessEvents\", \u0026Req, \u0026Rep) if ok \u0026\u0026 Rep.Stamp == Req.Stamp { switch Rep.MsgFlag { case TpSendMapTask: doMap(mapf, \u0026Rep) case TpSendReduceTask: doReduce(reducef, \u0026Rep) case TpWait: time.Sleep(time.Second) case TpTaskAllDone: return default: return } } } return } doMap(mapf, \u0026Rep) 和 doReduce(reducef, \u0026Rep) 就是非常简单的逻辑编写了。Map需要把文件分拆到N=numReduce块中，总共产生N * M(reduce num, map num)块文件。Reduce worker从自己对应的编号中取出M块进行排序和合并。\n结果顺利通过，没有过多的延迟(因为10s的判断)产生。\nFig 2. test mr Reference [1] “MapReduce: Simplified Data Processing on Large Clusters” googleusercontent.com.\n[2] Google cloud blog about MapReduce’s successor\n",
  "wordCount" : "959",
  "inLanguage": "en",
  "datePublished": "2023-01-17T00:00:00Z",
  "dateModified": "2023-01-17T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "chenghua.Wang"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://chenghuawang.github.io/keep-moving-forward/papers/mapreduce/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Ubios Home",
    "logo": {
      "@type": "ImageObject",
      "url": "https://chenghuawang.github.io/keep-moving-forward/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://chenghuawang.github.io/keep-moving-forward/" accesskey="h" title="Ubios Home (Alt + H)">Ubios Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://chenghuawang.github.io/keep-moving-forward/about/about/" title="关于我">
                    <span>关于我</span>
                </a>
            </li>
            <li>
                <a href="https://chenghuawang.github.io/keep-moving-forward/about/tech_posts/" title="技术相关">
                    <span>技术相关</span>
                </a>
            </li>
            <li>
                <a href="https://chenghuawang.github.io/keep-moving-forward/about/paper_posts/" title="论文解析">
                    <span>论文解析</span>
                </a>
            </li>
            <li>
                <a href="https://chenghuawang.github.io/keep-moving-forward/about/news/" title="🎉News🎉">
                    <span>🎉News🎉</span>
                </a>
            </li>
            <li>
                <a href="https://chenghuawang.github.io/keep-moving-forward/about/thingking/" title="思考">
                    <span>思考</span>
                </a>
            </li>
            <li>
                <a href="https://chenghuawang.github.io/keep-moving-forward/about/hpc_ai/" title="AI&amp;Sys 入门">
                    <span>AI&amp;Sys 入门</span>
                </a>
            </li>
            <li>
                <a href="https://chenghuawang.github.io/keep-moving-forward/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="https://chenghuawang.github.io/keep-moving-forward/series" title="系列文章">
                    <span>系列文章</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://chenghuawang.github.io/keep-moving-forward/">Home</a>&nbsp;»&nbsp;<a href="https://chenghuawang.github.io/keep-moving-forward/papers/">Papers</a></div>
    <h1 class="post-title entry-hint-parent">
      MapReduce
    </h1>
    <div class="post-meta"><span title='2023-01-17 00:00:00 +0000 UTC'>January 17, 2023</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;chenghua.Wang

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e4%bb%80%e4%b9%88%e6%98%af-mapreduce" aria-label="什么是 MapReduce">什么是 MapReduce</a><ul>
                        
                <li>
                    <a href="#mapreduce-%e7%9a%84%e8%ae%be%e8%ae%a1%e6%a1%86%e6%9e%b6%e5%92%8c%e5%9f%ba%e6%9c%ac%e6%b5%81%e7%a8%8b" aria-label="MapReduce 的设计框架和基本流程">MapReduce 的设计框架和基本流程</a></li></ul>
                </li>
                <li>
                    <a href="#mapreduce-%e7%9a%84%e4%bd%bf%e7%94%a8%e8%8c%83%e4%be%8b" aria-label="MapReduce 的使用范例">MapReduce 的使用范例</a></li>
                <li>
                    <a href="#mr-fault-tolerance" aria-label="MR Fault Tolerance">MR Fault Tolerance</a><ul>
                        
                <li>
                    <a href="#worker-failure" aria-label="Worker Failure">Worker Failure</a></li>
                <li>
                    <a href="#master-failure" aria-label="Master Failure">Master Failure</a></li></ul>
                </li>
                <li>
                    <a href="#mr-%e7%bc%ba%e9%99%b7" aria-label="MR 缺陷">MR 缺陷</a></li>
                <li>
                    <a href="#mr-lab-in-mit6824" aria-label="MR Lab in MIT6.824">MR Lab in MIT6.824</a></li>
                <li>
                    <a href="#reference" aria-label="Reference">Reference</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>OSDI'04: 6th Symposium on Operating Systems Design and Implementation</p>
<p><a href="/keep-moving-forward/">go back to home</a></p>
<p><a href="https://pdos.csail.mit.edu/6.824/papers/mapreduce.pdf">Paper link</a></p>
<hr>
<h1 id="什么是-mapreduce">什么是 MapReduce<a hidden class="anchor" aria-hidden="true" href="#什么是-mapreduce">#</a></h1>
<p>在MapReduce原文中是这么说的</p>
<blockquote>
<p>MapReduce is a programming model and an associated implementation for processing and generating large data sets. [1]</p>
</blockquote>
<p>这是一个较为简单的处理大型问题的分布式编程模型。其产生的原因是因为 google 想要让普通的程序员也能够通过一套简单的编程模型来编写分布式应用程序，以此来处理 google 内部的大数据。然后著名的 Jeff Dean 和 Sanjay Ghemawat 出马搞定了这个问题(<a href="https://www.zhihu.com/question/22081653">在知乎上关于Jeff Dean的轶事:-)</a>)。MapReduce 在 google 内部运行很长的时间并且处理了很多业务，但是目前也败下阵来，具体原因参见 MapReduce 缺陷章节(MR早在2004年就出来了，其实是古早的技术了，其没有在性能上做文章，主要在可扩展性上)。</p>
<h2 id="mapreduce-的设计框架和基本流程">MapReduce 的设计框架和基本流程<a hidden class="anchor" aria-hidden="true" href="#mapreduce-的设计框架和基本流程">#</a></h2>
<p>MR实际上是一个非常简单的框架，思路也非常的直白。MapReduce 背后的核心思想是将数据集映射到一个 <code>&lt;key, value&gt;</code> pair的集合中，然后使用相同的键对所有pair进行整合。 整体概念很简单，但是如果你设想下下面的情况，MR实际上非常有用: 基本上所有的数据都能被映射到一个 <code>&lt;key, value&gt;</code> 对中，并且key和value可以是任意类型。</p>
<p>在论文中MR使用的样例是在超大的文件里做单词统计。这个框架还可以用来做：</p>
<ol>
<li>分布式的排序</li>
<li>分布式的搜索</li>
<li>Web链接图遍历</li>
<li>&hellip;</li>
</ol>
<hr>
<figure>
    <img loading="lazy" src="MapReduceArch.png"
         alt="from &amp;ldquo;MapReduce: Simplified Data Processing on Large Clusters&amp;rdquo; googleusercontent.com."/> <figcaption>
            Fig 1. MapReduce Arch<p>from &ldquo;MapReduce: Simplified Data Processing on Large Clusters&rdquo; googleusercontent.com.</p>
        </figcaption>
</figure>

<p>MR 中的Map和Reduce是从函数式编程语言(LISP)中借鉴过来的一个概念。程序员只需要编写Map和Reduce两个函数就能够对某个任务并发处理。在 Fig 1 中，MR主要的流程分为6个部分</p>
<ol>
<li>
<p>用户程序的MR首先将输入文件分成 M 块，每块通常为 16 MB到 64 MB(可由用户通过参数控制)。 然后，它会在一组机器上启动该程序的多个副本。</p>
</li>
<li>
<p>这些副本中有一个控制程序(Master)。其余的程序(Worker)由控制程序(Master)来分配。有 M 个 Map 任务和 R 个 Reduce 任务要分配。Master 挑选空闲的 Worker 并为每个机器分配一个 Map 任务或 Reduce 任务。</p>
</li>
<li>
<p>分配了 map 任务的 worker 读取相应的内容(拆分后的文件块)(设想下，如果这里的文件读取需要从数据仓库中拿出，那么整个框架的计算能力极大的被网络所限制了)。它从输入数据中解析出<code>&lt;key, value&gt;</code>对，并将每一对传递给用户定义的 Map 函数。 Map 函数产生的中间<code>&lt;key, value&gt;</code>对被缓存在内存中。</p>
</li>
<li>
<p>缓存在机器中的中间<code>&lt;key, value&gt;</code>对周期性地被写入本地磁盘，由分区函数划分为 R 个区域。这些缓冲对在本地磁盘上的位置被传回 Master，Master 负责将这些位置转发给 Reduce Worker。</p>
</li>
<li>
<p>当 Master 通知 Reduce Worker 有关这些位置时，它会使用RPC从 Map Worker 的本地磁盘读取缓冲数据。当 Reduce Worker 读取所有中间数据时，它会按中间键对其进行排序，以便将所有出现的相同键组合在一起。排序是因为通常许多不同的键映射到同一个 Reduce 任务。如果中间数据量太大而无法放入内存，则使用外部排序。</p>
</li>
<li>
<p>Reduce Worker 迭代排序的中间数据，对于遇到的每个唯一中间键，它将键和相应的中间值集传递给用户的 Reduce 函数。Reduce 函数的输出到此 Reduce 分区的最终输出文件。</p>
</li>
<li>
<p>当所有的 Map 任务和 Reduce 任务都完成后，Master唤醒用户程序。此时用户程序中的 MR 调用返回给用户代码</p>
</li>
</ol>
<p>因为网络上的数据交换是非常缓慢的，作者在分发数据的时候尽量保证数据就在这台计算服务器上，而不需要传输数据。在原文中是这样说的：</p>
<blockquote>
<p>We conserve network bandwidth by taking advantage of the fact that the input data (managed by GFS) is stored on the local disks of the
machines that make up our cluster.</p>
</blockquote>
<h1 id="mapreduce-的使用范例">MapReduce 的使用范例<a hidden class="anchor" aria-hidden="true" href="#mapreduce-的使用范例">#</a></h1>
<p>论文中，以词频统计为例子，如论文中的伪代码：</p>
<pre tabindex="0"><code>map(String key, String value):
    // key: document name
    // value: document contents
    for each word w in value:
        EmitIntermediate(w, &#34;1&#34;);
</code></pre><pre tabindex="0"><code>reduce(String key, Iterator values):
    // key: a word
    // values: a list of counts
    int result = 0;
    for each v in values:
        result += ParseInt(v);
        Emit(AsString(result));
</code></pre><h1 id="mr-fault-tolerance">MR Fault Tolerance<a hidden class="anchor" aria-hidden="true" href="#mr-fault-tolerance">#</a></h1>
<p>Fault Tolerance 在分布式程序中是非常重要的。MR 主要的贡献点其实就在 scalability 和 fault tolerance。</p>
<h2 id="worker-failure">Worker Failure<a hidden class="anchor" aria-hidden="true" href="#worker-failure">#</a></h2>
<p>Master 会定期的 ping Worker 服务器，如果不通，那么这个 Worker 被设置成 idle，分配给这台机器的任务会被分发给其他的机器。</p>
<h2 id="master-failure">Master Failure<a hidden class="anchor" aria-hidden="true" href="#master-failure">#</a></h2>
<p>Master 因为只有少量的机器，所以发生错误的可能性非常的小。可以通过存储 Master 的状态为 checkpoints 来进行错误时回退和恢复。</p>
<h1 id="mr-缺陷">MR 缺陷<a hidden class="anchor" aria-hidden="true" href="#mr-缺陷">#</a></h1>
<p>MR 的缺陷实际上在 Google I/O 上已经说明了，如下:</p>
<blockquote>
<p>Today at Google I/O, we are demonstrating Google Cloud Dataflow for the first time. Cloud Dataflow is a fully managed service for creating data pipelines that ingest, transform and analyze data in both batch and streaming modes. Cloud Dataflow is a successor to MapReduce, and is based on our internal technologies like Flume and MillWheel.[2]</p>
</blockquote>
<ol>
<li>MR是一个基于 batch mode 的框架。</li>
<li>用 MR 写复杂的分析 pipeline 太麻烦。</li>
</ol>
<p>在很多情况下，一次 MR 执行是没法把事情做完的，需要很多个 MR 任务互相组合，这就是 MR pipeline. 在数据流复杂的分析任务中，设计好的 pipeline 达到最高运行效率很困难。</p>
<p>MR 最大的贡献我认为就是 scalability 和 fault tolerance。在 MillWheel 里，结果可以随着数据流的输入实时的显示出来，而不是到数据流结束时才输出一个结果，而且这样中间结果不需要保存下来。</p>
<h1 id="mr-lab-in-mit6824">MR Lab in MIT6.824<a hidden class="anchor" aria-hidden="true" href="#mr-lab-in-mit6824">#</a></h1>
<p><a href="https://pdos.csail.mit.edu/6.824/labs/lab-mr.html">Check the lab-mr page here</a></p>
<p>在本实验中，我们将构建一个 MapReduce 系统。 我们将实现一个调用应用程序 Map 和 Reduce 函数并处理读写文件的程序，以及一个将任务分发给 Worker 并处理失败的 Worker 的进程(Master)。在 MR 实验中，使用 Golang 来编码实现。</p>
<p>我的实现在 WSL Ubuntu20.04 上 go版本 1.18。</p>
<p>这次的要求貌似比以前更难了，这次需要 Worker 主动向 Master 请求任务，当任务超时后，需要 Master 来重新分配这个任务。</p>
<p>总体思路其实也非常的简单，worker 和 coordinator 的交互都围绕着 RPC 展开，故先从 RPC 的定义开始。因为深受事件轮询编程模式的&rsquo;荼毒&rsquo;，我把 worker 和 coordinator 之间的交互过程以事件的形式来进行处理。首先定义事件的类型。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// src/mr/rpc.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">TaskTp</span> <span class="p">=</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">TpRequireTask</span> <span class="p">=</span> <span class="kc">iota</span>
</span></span><span class="line"><span class="cl">	<span class="nx">TpMapTaskDone</span>
</span></span><span class="line"><span class="cl">	<span class="nx">TpReduceTaskDone</span>
</span></span><span class="line"><span class="cl">	<span class="nx">TpSendMapTask</span>
</span></span><span class="line"><span class="cl">	<span class="nx">TpSendReduceTask</span>
</span></span><span class="line"><span class="cl">	<span class="nx">TpTaskAllDone</span>
</span></span><span class="line"><span class="cl">	<span class="nx">TpWait</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>再来考虑 RPC 需要在 worker 和 coordinator 中传递什么信息？不论何种信息，首先都需要一个时间戳来记录 require 和 reply 对。其次每个 worker 都需要知道一共有多少个 Map 和 Reduce 任务。每个 require 需要跟上当前 worker 的任务编号。当然，因为是事件驱动的角度编写的，所以每条 require 和 reply 都需要有一个事件类型记录。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// src/mr/rpc.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">RequireMsg</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Stamp</span>   <span class="kt">int64</span>
</span></span><span class="line"><span class="cl">	<span class="nx">MsgFlag</span> <span class="nx">TaskTp</span>
</span></span><span class="line"><span class="cl">	<span class="nx">TaskID</span>  <span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">ReplyMsg</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Stamp</span>            <span class="kt">int64</span>
</span></span><span class="line"><span class="cl">	<span class="nx">MsgFlag</span>          <span class="nx">TaskTp</span>
</span></span><span class="line"><span class="cl">	<span class="nx">TaskID</span>           <span class="kt">int</span>
</span></span><span class="line"><span class="cl">	<span class="nx">NumReduceWorkers</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">	<span class="nx">NumMapWorkers</span>    <span class="kt">int</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Content</span>          <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<p>对于 coordinator，其作用像是一个状态机，需要维护所有的 worker 的状态，并能做到回退(Fault Tolerance)。Coordinator 的定义如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// src/mr/coordinator.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Coordinator</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">nMapWorkers</span>       <span class="kt">int</span>
</span></span><span class="line"><span class="cl">	<span class="nx">nReduceWorkers</span>    <span class="kt">int</span>
</span></span><span class="line"><span class="cl">	<span class="nx">nMapWorking</span>       <span class="kt">int</span>
</span></span><span class="line"><span class="cl">	<span class="nx">nReduceWorking</span>    <span class="kt">int</span>
</span></span><span class="line"><span class="cl">	<span class="nx">MapWorkerState</span>    <span class="p">[]</span><span class="kt">int64</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ReduceWorkerState</span> <span class="p">[]</span><span class="kt">int64</span>
</span></span><span class="line"><span class="cl">	<span class="nx">FilesContent</span>      <span class="p">[]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">MapWorkerPool</span>     <span class="kd">chan</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ReduceWorkerPool</span>  <span class="kd">chan</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">	<span class="nx">IsDone</span>            <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">	<span class="nx">GlobalLock</span>        <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Cond</span> <span class="c1">// to make sure the rpc visit is atomic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>coordinator 需要处理 RPC 的请求，对于不同的事件进行反应。因为需要超时处理，所以在这里，每一个 worker 都会有一个协程来进行相应的计时和 id 回收。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// src/mr/coordinator.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Coordinator</span><span class="p">)</span> <span class="nf">ProcessEvents</span><span class="p">(</span><span class="nx">args</span> <span class="o">*</span><span class="nx">RequireMsg</span><span class="p">,</span> <span class="nx">reply</span> <span class="o">*</span><span class="nx">ReplyMsg</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">GlobalLock</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tmpBool</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">IsDone</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">GlobalLock</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">tmpBool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">reply</span><span class="p">.</span><span class="nx">MsgFlag</span> <span class="p">=</span> <span class="nx">TpTaskAllDone</span>
</span></span><span class="line"><span class="cl">		<span class="nx">reply</span><span class="p">.</span><span class="nx">Stamp</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Stamp</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="nx">args</span><span class="p">.</span><span class="nx">MsgFlag</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">TpMapTaskDone</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">GlobalLock</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">MapWorkerState</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">TaskID</span><span class="p">]</span> <span class="o">==</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Stamp</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">MapWorkerState</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">TaskID</span><span class="p">]</span> <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">nMapWorking</span><span class="o">--</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">GlobalLock</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">TpReduceTaskDone</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">GlobalLock</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">ReduceWorkerState</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">TaskID</span><span class="p">]</span> <span class="o">==</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Stamp</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">ReduceWorkerState</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">TaskID</span><span class="p">]</span> <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">nReduceWorking</span><span class="o">--</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">nReduceWorking</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">IsDone</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">GlobalLock</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">TpRequireTask</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">MapWorkerPool</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// State 1. Send Map Task to worker.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">reply</span><span class="p">.</span><span class="nx">Stamp</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Stamp</span>
</span></span><span class="line"><span class="cl">			<span class="nx">reply</span><span class="p">.</span><span class="nx">TaskID</span> <span class="p">=</span> <span class="o">&lt;-</span><span class="nx">c</span><span class="p">.</span><span class="nx">MapWorkerPool</span>
</span></span><span class="line"><span class="cl">			<span class="nx">reply</span><span class="p">.</span><span class="nx">MsgFlag</span> <span class="p">=</span> <span class="nx">TpSendMapTask</span>
</span></span><span class="line"><span class="cl">			<span class="nx">reply</span><span class="p">.</span><span class="nx">NumMapWorkers</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">nMapWorkers</span>
</span></span><span class="line"><span class="cl">			<span class="nx">reply</span><span class="p">.</span><span class="nx">NumReduceWorkers</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">nReduceWorkers</span>
</span></span><span class="line"><span class="cl">			<span class="nx">reply</span><span class="p">.</span><span class="nx">Content</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">FilesContent</span><span class="p">[</span><span class="nx">reply</span><span class="p">.</span><span class="nx">TaskID</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">GlobalLock</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">MapWorkerState</span><span class="p">[</span><span class="nx">reply</span><span class="p">.</span><span class="nx">TaskID</span><span class="p">]</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Stamp</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">GlobalLock</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">id</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="nx">c</span><span class="p">.</span><span class="nx">GlobalLock</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">MapWorkerState</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="c1">// run out of 10 secs. recycle this id to id pool.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="nx">c</span><span class="p">.</span><span class="nx">MapWorkerPool</span> <span class="o">&lt;-</span> <span class="nx">id</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="nx">c</span><span class="p">.</span><span class="nx">GlobalLock</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="p">}(</span><span class="nx">reply</span><span class="p">.</span><span class="nx">TaskID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">GlobalLock</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">nMapOnWorking</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">nMapWorking</span>
</span></span><span class="line"><span class="cl">			<span class="nx">nReduceOnWorking</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">nReduceWorking</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">GlobalLock</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// State 2. All map worker is on working. wait.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">nMapOnWorking</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">reply</span><span class="p">.</span><span class="nx">Stamp</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Stamp</span>
</span></span><span class="line"><span class="cl">				<span class="nx">reply</span><span class="p">.</span><span class="nx">TaskID</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">				<span class="nx">reply</span><span class="p">.</span><span class="nx">MsgFlag</span> <span class="p">=</span> <span class="nx">TpWait</span>
</span></span><span class="line"><span class="cl">				<span class="nx">reply</span><span class="p">.</span><span class="nx">Content</span> <span class="p">=</span> <span class="s">&#34;Just Wait !!! Map Worker !!!&#34;</span>
</span></span><span class="line"><span class="cl">				<span class="nx">reply</span><span class="p">.</span><span class="nx">NumMapWorkers</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">nMapWorkers</span>
</span></span><span class="line"><span class="cl">				<span class="nx">reply</span><span class="p">.</span><span class="nx">NumReduceWorkers</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">nReduceWorkers</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// State 3. Map is Done. Send Reduce task to works.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">ReduceWorkerPool</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">reply</span><span class="p">.</span><span class="nx">Stamp</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Stamp</span>
</span></span><span class="line"><span class="cl">					<span class="nx">reply</span><span class="p">.</span><span class="nx">TaskID</span> <span class="p">=</span> <span class="o">&lt;-</span><span class="nx">c</span><span class="p">.</span><span class="nx">ReduceWorkerPool</span>
</span></span><span class="line"><span class="cl">					<span class="nx">reply</span><span class="p">.</span><span class="nx">MsgFlag</span> <span class="p">=</span> <span class="nx">TpSendReduceTask</span>
</span></span><span class="line"><span class="cl">					<span class="nx">reply</span><span class="p">.</span><span class="nx">Content</span> <span class="p">=</span> <span class="s">&#34;Reduce no need to handle this&#34;</span>
</span></span><span class="line"><span class="cl">					<span class="nx">reply</span><span class="p">.</span><span class="nx">NumMapWorkers</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">nMapWorkers</span>
</span></span><span class="line"><span class="cl">					<span class="nx">reply</span><span class="p">.</span><span class="nx">NumReduceWorkers</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">nReduceWorkers</span>
</span></span><span class="line"><span class="cl">					<span class="nx">c</span><span class="p">.</span><span class="nx">GlobalLock</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">					<span class="nx">c</span><span class="p">.</span><span class="nx">ReduceWorkerState</span><span class="p">[</span><span class="nx">reply</span><span class="p">.</span><span class="nx">TaskID</span><span class="p">]</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Stamp</span>
</span></span><span class="line"><span class="cl">					<span class="nx">c</span><span class="p">.</span><span class="nx">GlobalLock</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">					<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">id</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">						<span class="nx">c</span><span class="p">.</span><span class="nx">GlobalLock</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">						<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">ReduceWorkerState</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">							<span class="c1">// run out of 10 secs. resolved this id to id pool.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>							<span class="nx">c</span><span class="p">.</span><span class="nx">ReduceWorkerPool</span> <span class="o">&lt;-</span> <span class="nx">id</span>
</span></span><span class="line"><span class="cl">						<span class="p">}</span>
</span></span><span class="line"><span class="cl">						<span class="nx">c</span><span class="p">.</span><span class="nx">GlobalLock</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">					<span class="p">}(</span><span class="nx">reply</span><span class="p">.</span><span class="nx">TaskID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="c1">// State 4. All reduce worker is on working. wait.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="k">if</span> <span class="nx">nReduceOnWorking</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="nx">reply</span><span class="p">.</span><span class="nx">Stamp</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Stamp</span>
</span></span><span class="line"><span class="cl">						<span class="nx">reply</span><span class="p">.</span><span class="nx">TaskID</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">						<span class="nx">reply</span><span class="p">.</span><span class="nx">MsgFlag</span> <span class="p">=</span> <span class="nx">TpWait</span>
</span></span><span class="line"><span class="cl">						<span class="nx">reply</span><span class="p">.</span><span class="nx">Content</span> <span class="p">=</span> <span class="s">&#34;Just Wait !!! Reduce Worker !!!&#34;</span>
</span></span><span class="line"><span class="cl">						<span class="nx">reply</span><span class="p">.</span><span class="nx">NumMapWorkers</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">nMapWorkers</span>
</span></span><span class="line"><span class="cl">						<span class="nx">reply</span><span class="p">.</span><span class="nx">NumReduceWorkers</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">nReduceWorkers</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>同样的，在 worker 中的流程也是不断的循环产生事件，处理事件</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// src/mr/worker.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Worker</span><span class="p">(</span><span class="nx">mapf</span> <span class="kd">func</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">)</span> <span class="p">[]</span><span class="nx">KeyValue</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">reducef</span> <span class="kd">func</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="kc">true</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ThisStamp</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Unix</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Req</span> <span class="o">:=</span> <span class="nx">RequireMsg</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Req</span><span class="p">.</span><span class="nx">Stamp</span> <span class="p">=</span> <span class="nx">ThisStamp</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Req</span><span class="p">.</span><span class="nx">MsgFlag</span> <span class="p">=</span> <span class="nx">TpRequireTask</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Req</span><span class="p">.</span><span class="nx">TaskID</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Rep</span> <span class="o">:=</span> <span class="nx">ReplyMsg</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ok</span> <span class="o">:=</span> <span class="nf">call</span><span class="p">(</span><span class="s">&#34;Coordinator.ProcessEvents&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">Req</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">Rep</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">Rep</span><span class="p">.</span><span class="nx">Stamp</span> <span class="o">==</span> <span class="nx">Req</span><span class="p">.</span><span class="nx">Stamp</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">switch</span> <span class="nx">Rep</span><span class="p">.</span><span class="nx">MsgFlag</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nx">TpSendMapTask</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="nf">doMap</span><span class="p">(</span><span class="nx">mapf</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">Rep</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nx">TpSendReduceTask</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="nf">doReduce</span><span class="p">(</span><span class="nx">reducef</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">Rep</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nx">TpWait</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nx">TpTaskAllDone</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>doMap(mapf, &amp;Rep)</code> 和 <code>doReduce(reducef, &amp;Rep)</code> 就是非常简单的逻辑编写了。Map需要把文件分拆到<code>N=numReduce</code>块中，总共产生<code>N * M(reduce num, map num)</code>块文件。Reduce worker从自己对应的编号中取出<code>M</code>块进行排序和合并。</p>
<hr>
<p>结果顺利通过，没有过多的延迟(因为10s的判断)产生。</p>
<figure>
    <img loading="lazy" src="test-mr-pass.png"/> <figcaption>
            Fig 2. test mr
        </figcaption>
</figure>

<h1 id="reference">Reference<a hidden class="anchor" aria-hidden="true" href="#reference">#</a></h1>
<p>[1] &ldquo;MapReduce: Simplified Data Processing on Large Clusters&rdquo; googleusercontent.com.</p>
<p>[2] <a href="https://cloudplatform.googleblog.com/2014/06/reimagining-developer-productivity-and-data-analytics-in-the-cloud-news-from-google-io.html">Google cloud blog about MapReduce&rsquo;s successor</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://chenghuawang.github.io/keep-moving-forward/papers/gfs/">
    <span class="title">« Prev</span>
    <br>
    <span>Google File System(GFS)</span>
  </a>
  <a class="next" href="https://chenghuawang.github.io/keep-moving-forward/tech/fundamental_quantization/">
    <span class="title">Next »</span>
    <br>
    <span></span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share MapReduce on x"
            href="https://x.com/intent/tweet/?text=MapReduce&amp;url=https%3a%2f%2fchenghuawang.github.io%2fkeep-moving-forward%2fpapers%2fmapreduce%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share MapReduce on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fchenghuawang.github.io%2fkeep-moving-forward%2fpapers%2fmapreduce%2f&amp;title=MapReduce&amp;summary=MapReduce&amp;source=https%3a%2f%2fchenghuawang.github.io%2fkeep-moving-forward%2fpapers%2fmapreduce%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share MapReduce on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fchenghuawang.github.io%2fkeep-moving-forward%2fpapers%2fmapreduce%2f&title=MapReduce">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share MapReduce on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fchenghuawang.github.io%2fkeep-moving-forward%2fpapers%2fmapreduce%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share MapReduce on whatsapp"
            href="https://api.whatsapp.com/send?text=MapReduce%20-%20https%3a%2f%2fchenghuawang.github.io%2fkeep-moving-forward%2fpapers%2fmapreduce%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share MapReduce on telegram"
            href="https://telegram.me/share/url?text=MapReduce&amp;url=https%3a%2f%2fchenghuawang.github.io%2fkeep-moving-forward%2fpapers%2fmapreduce%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share MapReduce on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=MapReduce&u=https%3a%2f%2fchenghuawang.github.io%2fkeep-moving-forward%2fpapers%2fmapreduce%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>© <a href="https://github.com/chenghuaWang">chenghua.wang</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a><script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
const images = Array.from(document.querySelectorAll(".post-content img"));
images.forEach(img => {
  mediumZoom(img, {
    margin: 0,  
    scrollOffset: 40,  
    container: null,  
    template: null,  
    background: 'rgba(0, 0, 0, 0.8)'
  });
});
</script>
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5j20jf9ml5x&amp;m=0&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33" async="async"></script>


<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
